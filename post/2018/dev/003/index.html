<!DOCTYPE html>
<html lang="es-es">
<head>
	<title>Unity3D Plugins ¿Que son? &middot; Antonio Moon´s</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Moon Antonio">
	<meta name="description" content="un blog sobre mi, juegos, desarrollo y anime">
	<meta name="keywords" content="Moon,Antonio,Dev,Game">
	<meta name="generator" content="Hugo 0.74.3" />

	<!-- CSS -->
	<link rel="stylesheet" href="https://moonantonio.github.io/css/main.css">
	<link rel='stylesheet' href='/css/prism.css' />
	
	<!-- Favicon -->
	<link rel="apple-touch-icon" href="https://moonantonio.github.io/apple-touch-icon.png">
	<link rel="shortcut icon" href="https://moonantonio.github.io/favicon.ico" type="image/x-icon">
	<link rel="icon" type="image/png" sizes="32x32" href="https://moonantonio.github.io/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://moonantonio.github.io/favicon-16x16.png">
	<link rel="manifest" href="https://moonantonio.github.io/site.webmanifest">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">

	

	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/solid.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/brands.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/fontawesome.min.css">

	<!-- Google Fonts -->
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
</head>

<body>
	<header class="site-header">
	<div class="branding">
		<a href="https://moonantonio.github.io/">
		<img class="avatar" src="https://moonantonio.github.io/img/avatar.png" alt="avatar"/>
		</a>
		<h1 class="site-title">
				<i class="fas fa-angle-right"></i>
				<span class="logo__text">Antonio Moon´s</span>
				<span class="logo__cursor"></span>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/devblog/" title="devBlog">
  		</i>&nbsp; devBlog</a> <i class="fas fa-gamepad" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/backdoor" title="BackDoor">
  		</i>&nbsp; BackDoor</a> <i class="fab fa-black-tie" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://github.com/MoonAntonio/rec.repos" title="Public">
  		</i>&nbsp; Publico</a> <i class="fas fa-code" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/portfolio/" title="About">
  		</i>&nbsp; About</a> <i class="fas fa-terminal" aria-hidden="true"></i>
  </a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/" title="&#43;">
		</i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>
	</a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/" title="">
		<i class="fas fa-fw fa-home"></i>
	</a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/index.xml" title="Subcribe">
		<i class="fas fa-fw fa-rss"></i>
	</a>
</li>

<li class="icon">
	<a href="mailto:antoniomt.moon@gmail.com" title="Email">
		<i class="fas fa-fw fa-envelope"></i>
	</a>
</li>



<li class="icon">
	<a href="https://bitbucket.org/MoonAntonio" rel="me" title="Bitbucket">
		<i class="fab fa-fw fa-bitbucket"></i>
	</a>
</li>







<li class="icon">
	<a href="https://github.com/MoonAntonio" rel="me" title="GitHub">
		<i class="fab fa-fw fa-github"></i>
	</a>
</li>

























<li class="icon">
	<a href="https://trello.com/antoniomoon" rel="me" title="Trello">
		<i class="fab fa-fw fa-trello"></i>
	</a>
</li>

<li class="icon">
	<a href="https://gitlab.com/MoonAntonio" rel="me" title="Gitlab">
		<i class="fab fa-fw fa-gitlab"></i>
	</a>
</li>





		</ul>
	</nav>
</header>


	<div class="content">
	<article class="feature-image">
		<header style="background-image: url('https://moonantonio.github.io/img/bg.png')">
			
			<h1 class="title">Unity3D Plugins ¿Que son?</h1>
			
		</header>

		<section class="post-content">
			<p>Hoy decidi compartir, algo que creo que no es un <strong>&ldquo;conocimiento común&rdquo;</strong> y no hay muchos recursos sobre ese tema en Internet, despues de que varios colegas que estan empezando en este mundo, me preguntasen como poder usar APIs en otros lenguajes en Unity3D, como por ejemplo el <strong>SKD de Steam</strong> que esta en C++ o las librerias .JAR de Android decidi crear una entrada nueva. Mostrare como crear bibliotecas simples de C/C++ para Unity3D.</p>
<h2 id="introduccion">Introduccion</h2>
<p>Alguna vez te has preguntado, <strong>¿Como los modders crean funcionalidad para los juegos?</strong>, pues la respuesta es esta, crean <strong>plugins que interferir la API publica</strong> de los juegos (Variables, metodos, funciones publicos) y luego con lenguaje pegamento crean la llamada si esque no se puede llamar desde el mismo core.</p>
<hr>
<p>Puede preguntar, <strong>¿por que deberia molestarme en escribir C o C++ cuando Unity admite C #?</strong></p>
<p>La respuesta es simple. Es mucho <strong>más rápido</strong>, trabajar a <a href="http://bit.ly/2MFbKoQ">bajo nivel</a> cambia mucho las cosas. Decidi preparar algunos ejemplos solo para mostrar como C++ supera C# basado Mono.</p>
<p>Ejemplos:</p>
<table>
<thead>
<tr>
<th>Prueba de Estres</th>
<th>Unity C#</th>
<th>Biblioteca C/C++</th>
</tr>
</thead>
<tbody>
<tr>
<td>Array de enteros de 10000 x 10000</td>
<td>1.0258 segundos</td>
<td>0.2346 segundos</td>
</tr>
<tr>
<td>Array de enteros de 500 x 500</td>
<td>3.794 milisegundos</td>
<td>0.35 milisegundos</td>
</tr>
<tr>
<td>Array de enteros de 10000 x 10000 con numeros aleatorios</td>
<td>4.26 segundos</td>
<td>0.995 segundos</td>
</tr>
</tbody>
</table>
<hr>
<p>Pros y contras de C/C++ y Unity3D</p>
<h3 id="pros">Pros</h3>
<ol>
<li>Triplica (en algunos casos) la velocidad de calculo.</li>
<li>Las dlls no afectan al rendimiento de unity.</li>
</ol>
<h3 id="contras">Contras</h3>
<ol>
<li>Unity no admite directamente C++.</li>
<li>La velocidad que se ahorra en runtime, se pierde realizando las dlls.</li>
</ol>
<hr>
<h2 id="crear-biblioteca-c">Crear biblioteca C++</h2>
<p>En este caso, yo usare Code::Blocks, pero podeis usar cualquier IDE que querais. Voy a crear un proyecto de libreria dinamica (.dll) llamado LowLevelPlugin. Ya que vamos a trabajar a bajo nivel.</p>
<p>Nos iremos al encabezado main.h y eliminaremos todo el contenido que se ha generado automaticamente.</p>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">#ifndef __MAIN_H__
</span><span style="color:#75715e">#define __MAIN_H__
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*  To use this exported function of dll, include this header
</span><span style="color:#75715e"> *  in your project.
</span><span style="color:#75715e"> */</span>

<span style="color:#75715e">#ifdef BUILD_DLL
</span><span style="color:#75715e"></span>    <span style="color:#75715e">#define DLL_EXPORT __declspec(dllexport)
</span><span style="color:#75715e">#else
</span><span style="color:#75715e"></span>    <span style="color:#75715e">#define DLL_EXPORT __declspec(dllimport)
</span><span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>

<span style="color:#75715e">#ifdef __cplusplus
</span><span style="color:#75715e"></span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span>
{
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> DLL_EXPORT <span style="color:#a6e22e">SomeFunction</span>(<span style="color:#66d9ef">const</span> LPCSTR sometext);

<span style="color:#75715e">#ifdef __cplusplus
</span><span style="color:#75715e"></span>}
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#endif </span><span style="color:#75715e">// __MAIN_H__
</span></code></pre></div><hr>
<p>En su caso colocaremos esto otro -&gt;</p>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">#pragma once
</span><span style="color:#75715e">#if UNITY_METRO
</span><span style="color:#75715e">#define EXPORT_API __declspec(dllexport) __stdcall
</span><span style="color:#75715e">#elif UNITY_WIN
</span><span style="color:#75715e">#define EXPORT_API __declspec(dllexport)
</span><span style="color:#75715e">#else
</span><span style="color:#75715e">#define EXPORT_API
</span><span style="color:#75715e">#endif
</span></code></pre></div><hr>
<p>El propósito de este encabezado completo es comportarse de manera diferente basándose en qué plataforma está compilando actualmente su código. Significa que puede compilarlo fácilmente en Visual Studio.</p>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">#pragma once
</span></code></pre></div><hr>
<ul>
<li>#pragma once es una directiva específica C/C++ diseñada para hacer que el archivo fuente actual se incluya solo una vez en una sola compilación.</li>
</ul>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">#if UNITY_METRO
</span></code></pre></div><hr>
<ul>
<li>Esto le dice al compilador que ejecute este bloque si solo estamos corriendo en Windows basado en Metro, por ejemplo, 8.1. Esto os sonara de Unity si habeis usado las <a href="https://docs.unity3d.com/es/current/Manual/PlatformDependentCompilation.html">directivas de compilacion de plataforma</a>.</li>
</ul>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">#define EXPORT_API __declspec(dllexport) __stdcall
</span></code></pre></div><hr>
<ul>
<li>La palabra clave &ldquo;define&rdquo; funciona de manera similar a la función replace, su sintaxis se puede definir de la siguiente manera:</li>
</ul>
<p>define &lsquo;Esto&rsquo; &lsquo;Por esto&rsquo;.</p>
<p>En nuestro caso, cada vez que el compilador ve la secuencia de caracteres EXPORT_API en el código, la reemplaza con la segunda parte. Del mismo modo, el compilador se comportará en caso de que compile su código en ventanas antiguas, reemplace EXPORT_API con __declspec(dllexport) y simplemente elimine EXPORT_API en cualquier otro caso.</p>
<p>Eso es todo cuando se trata de encabezado. Ahora pasemos a algo que sea más interesante, el código fuente real. En el archivo main.cpp pegue el siguiente código:</p>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;math.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;main.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">**</span> EXPORT_API fillArray(<span style="color:#66d9ef">int</span> size)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> <span style="color:#f92672">**</span> array <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span><span style="color:#f92672">**</span>) calloc(size, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>));

    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> size; i<span style="color:#f92672">++</span>)
    {
        array[i] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>) calloc(size, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
        <span style="color:#66d9ef">for</span>(j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> size; j<span style="color:#f92672">++</span>)
        {
            array[i][j] <span style="color:#f92672">=</span> i <span style="color:#f92672">*</span> size <span style="color:#f92672">+</span> j;
        }
    }

    <span style="color:#66d9ef">return</span> array;
}
</code></pre></div><hr>
<p>Las primeras tres líneas son en mi humilde opinión autoexplicativas. Simplemente estamos agregando algunas bibliotecas estándar y nuestro archivo de encabezado recién creado.</p>
<p>El siguiente es:</p>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">**</span> EXPORT_API fillArray(<span style="color:#66d9ef">int</span> size) {
</code></pre></div><hr>
<p>Esta es nuestra declaración de función. Nuestra función se llama &ldquo;fillArray&rdquo;, toma un argumento int y devuelve una matriz de enteros bidimensional. (Sí, ** significa dos dimensiones) Word &ldquo;extern&rdquo; extiende la visibilidad a todo el programa, las funciones se pueden usar en cualquier lugar en cualquiera de los archivos de todo el programa y fuera de nuestra biblioteca/plugin. También tenemos nuestra palabra clave EXPORT_API.</p>
<p>La siguiente linea es:</p>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">int</span> <span style="color:#f92672">**</span> array <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span><span style="color:#f92672">**</span>) calloc(size, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>));
</code></pre></div><hr>
<p>Aquí estoy definiendo int-array bidimensional y luego estoy asignando memoria para ello. Como estoy escribiendo código en C++, no puedo simplemente crear una matriz y asignar valores. Tengo que reservar algo de espacio en memoria para eso y luego hacer cualquier operación. En este caso particular, estoy asignando las siguientes &ldquo;celdas&rdquo; de memoria de N de tamaño de int* y lo convierto al tipo bidimensional int array.</p>
<p>Lo mismo que estoy haciendo aquí:</p>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">array[i] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>) calloc(size, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
</code></pre></div><hr>
<p>La única diferencia es que ahora estoy asignando memoria para cada fila &ldquo;i&rsquo;t&rdquo; de una matriz.</p>
<p>Y al final estoy devolviendo un conjunto lleno. Espero que para los bucles y la asignación de valores sea obvio, así que no lo explicaré.</p>
<p>Ahora solo compilamos y se creara la dll.</p>
<!-- raw HTML omitted -->
<h2 id="implementar-puente-en-unity3d">Implementar puente en Unity3D</h2>
<p>Copia la dll en un Proyecto Unity3D dentro de la carpeta plugins en /Assets/Plugins. También debe crear un script C# en el directorio base para que la estructura de su proyecto tenga este aspecto:</p>
<!-- raw HTML omitted -->
<p>En la parte superior de tu script C # agrega &ldquo;Using System.Runtime.InteropServices;&rdquo;, luego la declaracion de la funcion de la dll, crea una matriz y por ultimo asigna a la variable la llamada.</p>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> size = <span style="color:#ae81ff">512</span>;
<span style="color:#a6e22e">[DllImport(&#34;LowLevelPlugin&#34;)]</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span>[,] fillArray(<span style="color:#66d9ef">int</span> size);

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> Start()
{
	ArrayFillTest();
}

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> ArrayFillTest()
{
	<span style="color:#66d9ef">var</span> start = Time.realtimeSinceStartup;
	<span style="color:#66d9ef">int</span>[,] tab = fillArray(size);
	Debug.Log((Time.realtimeSinceStartup - start).ToString(<span style="color:#e6db74">&#34;f6&#34;</span>) + <span style="color:#e6db74">&#34; secs&#34;</span>);
	start = Time.realtimeSinceStartup;
	<span style="color:#66d9ef">int</span>[,] array = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span>[size, size];
	<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; size; i++)
	{
		<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j = <span style="color:#ae81ff">0</span>; j &lt; size; j++)
		{
			array[i, j] = i * size + j;
		}
	}
	Debug.Log((Time.realtimeSinceStartup - start).ToString(<span style="color:#e6db74">&#34;f6&#34;</span>) + <span style="color:#e6db74">&#34; secs&#34;</span>);
}
</code></pre></div><hr>
<h2 id="conclusiones">Conclusiones</h2>
<p>Siempre que ejecutes codigo de bajo nivel, tendras mejores resultados.</p>
<hr>
<h2 id="repositorio">Repositorio</h2>
<!-- raw HTML omitted -->


			
		</section>
	</article>

	
	<div class="comments contribute-link">

	</div>
	<div class="comments related-posts">
		
			

<h3>Continuar Leyendo</h3>
<ul>
	
	<li><a href="/post/2018/dev/002/">ScriptableObjects</a></li>
	
	<li><a href="/post/2018/dev/001/">MonoBehavior en Unity</a></li>
	
	<li><a href="/post/2017/programacion/007/">Clase Abstracta VS Interfaces</a></li>
	
	<li><a href="/post/2017/diario/010/">Feliz 2018 y nuevas noticias con el</a></li>
	
	<li><a href="/post/2017/utiles/016/">Motores para Videojuegos</a></li>
	
</ul>

		
	</div>
	
	</div>

	<footer class="site-footer">
	<p class="text">&copy; 2020 - Moon Antonio</p>
</footer>
<script src='/js/prism.js'></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-89564434-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</body>
</html>
