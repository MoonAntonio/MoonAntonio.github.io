<!DOCTYPE html>
<html lang="es-es">
<head>
	<title>Estudio de UNET &middot; Antonio Moon´s</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Moon Antonio">
	<meta name="description" content="un blog sobre mi, juegos, desarrollo y anime">
	<meta name="keywords" content="Moon,Antonio,Dev,Game">
	<meta name="generator" content="Hugo 0.74.3" />

	<!-- CSS -->
	<link rel="stylesheet" href="https://moonantonio.github.io/css/main.css">
	<link rel='stylesheet' href='/css/prism.css' />
	
	<!-- Favicon -->
	<link rel="apple-touch-icon" href="https://moonantonio.github.io/apple-touch-icon.png">
	<link rel="shortcut icon" href="https://moonantonio.github.io/favicon.ico" type="image/x-icon">
	<link rel="icon" type="image/png" sizes="32x32" href="https://moonantonio.github.io/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://moonantonio.github.io/favicon-16x16.png">
	<link rel="manifest" href="https://moonantonio.github.io/site.webmanifest">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">

	

	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/solid.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/brands.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/fontawesome.min.css">

	<!-- Google Fonts -->
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
</head>

<body>
	<header class="site-header">
	<div class="branding">
		<a href="https://moonantonio.github.io/">
		<img class="avatar" src="https://moonantonio.github.io/img/avatar.png" alt="avatar"/>
		</a>
		<h1 class="site-title">
				<i class="fas fa-angle-right"></i>
				<span class="logo__text">Antonio Moon´s</span>
				<span class="logo__cursor"></span>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/devblog/" title="devBlog">
  		</i>&nbsp; devBlog</a> <i class="fas fa-gamepad" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/backdoor" title="BackDoor">
  		</i>&nbsp; BackDoor</a> <i class="fab fa-black-tie" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://github.com/MoonAntonio/rec.repos" title="Public">
  		</i>&nbsp; Publico</a> <i class="fas fa-code" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/portfolio/" title="About">
  		</i>&nbsp; About</a> <i class="fas fa-terminal" aria-hidden="true"></i>
  </a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/" title="&#43;">
		</i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>
	</a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/" title="">
		<i class="fas fa-fw fa-home"></i>
	</a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/index.xml" title="Subcribe">
		<i class="fas fa-fw fa-rss"></i>
	</a>
</li>

<li class="icon">
	<a href="mailto:antoniomt.moon@gmail.com" title="Email">
		<i class="fas fa-fw fa-envelope"></i>
	</a>
</li>



<li class="icon">
	<a href="https://bitbucket.org/MoonAntonio" rel="me" title="Bitbucket">
		<i class="fab fa-fw fa-bitbucket"></i>
	</a>
</li>







<li class="icon">
	<a href="https://github.com/MoonAntonio" rel="me" title="GitHub">
		<i class="fab fa-fw fa-github"></i>
	</a>
</li>

























<li class="icon">
	<a href="https://trello.com/antoniomoon" rel="me" title="Trello">
		<i class="fab fa-fw fa-trello"></i>
	</a>
</li>

<li class="icon">
	<a href="https://gitlab.com/MoonAntonio" rel="me" title="Gitlab">
		<i class="fab fa-fw fa-gitlab"></i>
	</a>
</li>





		</ul>
	</nav>
</header>


	<div class="content">
	<article class="feature-image">
		<header style="background-image: url('https://moonantonio.github.io/img/bg.png')">
			
			<h1 class="title">Estudio de UNET</h1>
			
		</header>

		<section class="post-content">
			<p>Esta entrada, es un recordatorio personal, despues de hablar con amigos y de hablarme tan bien de UNET (Yo solo toque NET en Unity 3.5, :S), me entro el gusanico de ver esta nueva tecnologia, por lo que decidi ponerme a investigar, pero descubri que hay muy poca información sobre esto.</p>
<p>Detallo en más profundidad, hay información, pero del High API. Lo que yo queria ver es información sobre el Low API y de esto hay poco, asi que decidi crear esta entrada para guardar como recuerdo este estudio, por si proximamente tengo que volver a mirarlo (soy un neurotico del guardado de datos xD).</p>
<p>También agradecer a <strong>Alejandro Rivas y Fernando Galan</strong> por la ayuda e info que me dieron y siguen dandome.</p>
<h1 id="conceptos-necesarios">Conceptos necesarios</h1>
<p>Un <strong>sistema de red</strong> en videojuegos implica que los <strong>participantes pueden jugar juntos a través de la conexión entre ellos</strong> por medio de una red, ya sea una red de área local o el Internet. Esto quiere decir que uno o varios clientes se conectan a un servidor, para intercambiar datos.</p>
<hr>
<!-- raw HTML omitted -->
<hr>
<p>En esencia, un <strong>cliente le dice al servidor lo que esta realizando y el servidor remite la información para todos los clientes</strong>, sincronizando sus estados. Este metodo se realiza desde cada cliente, haciendo asi que todos los clientes sean sincronizados por el servidor.</p>
<hr>
<!-- raw HTML omitted -->
<hr>
<p>Se le suele llamar a un servidor, <strong>servidor dedicado, ya que solo efectua el cambio de datos y no ejecuta ninguna instancia</strong>. Pero también existen otros tipos de servidores. Por ejemplo en Warcraft 3, cualquier cliente puede crear una partida desde su cliente, esto realmente es levantar un servidor para que otros jugadores puedan conectar con el como clientes, a la vez, el servidor tambien podra ser un cliente.</p>
<hr>
<!-- raw HTML omitted -->
<hr>
<p>Incluso se puede implementar una capa más, comunmente llamado <strong>matchmaker</strong>, que es la instancia de un servidor que congrega las partidas de otros servidores, de esta forma los clientes conectan con el servidor principal, que este a su vez conecta con los demas servidores.</p>
<hr>
<!-- raw HTML omitted -->
<hr>
<h1 id="empezamos-el-planteamiento">Empezamos el planteamiento</h1>
<p>Como siempre al final de la entrada dejo el <strong>link del repositorio en Github</strong> para los que quieran descargarlo. Doy por sentado que ya conoceis Unity y teneis un conocimiento sobre su funcionamiento.</p>
<p>Lo primero que necesitaremos, sera un <strong>Manager para gestionar toda la informacion de nuestro servidor</strong>. Este Manager no puede desaparecer nunca, ya que si lo hace, el servidor y todas las <strong>conexiones se caeran</strong>.</p>
<p>Crearemos un objeto vacio y le agregaremos el componente <strong>Network Manager que sera nuestro objeto para administrar la red</strong>.</p>
<hr>
<!-- raw HTML omitted -->
<hr>
<p>Este componente nos proporcionara mucha funcionalidad necesaria que podriamos escribirla desde cero pero ya que esta y no buscamos un sistema mega optimizado vamos a usarlo. Este componente ya lleva un valor booleano**(Dont destroy on load)** para decirle si quereis que el objeto sea destruido o que no se destruya nunca. También dispone de otro valor**(Run in Background)** para decidir si se ejecutara en segundo plano, Unity si no tiene este valor activado, al salir de Unity o del juego, se queda sin el foco y por lo tanto se pausa, esto seria malo si queremos que nuestros clientes reciban la información a tiempo.</p>
<p>Ahora vamos a agregarle un nuevo componente, llamado <strong>Network Manager HUD</strong>. Este componente nos facilita una <strong>interfaz con la funcionalidad necesaria</strong> para conectar con un servidor, levantar nuestro servidor o activar un matchmaker.</p>
<hr>
<!-- raw HTML omitted -->
<hr>
<p>Si construimos ahora mismo la aplicación, veremos como podemos crear dos o tres instancias de Unity y con ello poder conectarlas entre ellas.</p>
<p>Ahora que ya tenemos un administrador de red, tenemos que ver en sus opciones <strong>spawn info</strong>, una opcion de player prefab. Esto nos indica que este cliente tiene que instanciar algo. Pero no se refiere a algo fisico, sino que tiene que tener una instancia de jugador en memoria. Digamoslo de la siguiente manera como vemos en la siguiente imagen.</p>
<hr>
<!-- raw HTML omitted -->
<hr>
<p>Cada jugador tiene que tener una <strong>presencia no fisica</strong>, es decir, pongamos el objeto que poneis como spawn, es un objeto que posteriormente es destruido o desactivado, esto quitaria la presencia del cliente en el servidor, por que no tiene ninguna instancia. Por ello tenemos que realizar una buena praxis.</p>
<p>Creamos un objeto vacio, <strong>que contendra la información persistente del cliente/usuario</strong> y le <strong>agregaremos el componente network identity</strong>, que es un componente para obtener la identificacion del objeto en la red. Luego crearemos su prefab y la agregaremos al prefab del spawn. Básicamente es un puntero a nuestro objeto de red.</p>
<p>Esto realiza más facil la relacion amor odio de nuestros clientes/servidor.</p>
<hr>
<blockquote>
<p><em><strong>Representación Dramatica</strong></em></p>
</blockquote>
<blockquote>
<ul>
<li>Cliente : El jugador 18 tiene que moverse 3 pixeles a la derecha</li>
<li>Servidor : Sincronizando &hellip;</li>
<li>Cliente : Gracias</li>
</ul>
</blockquote>
<hr>
<!-- raw HTML omitted -->
<hr>
<p>Ahora tenemos un pequeño problema. Si comprobamos cuando iniciamos dos instancias o mas, <strong>cada jugador instancia el mismo objeto</strong>. Vamos a cambiar eso.
He creado un script y se lo he agregado a nuestro prefab de player.</p>
<p>Empezaremos por sincronizar la instancia fisica del jugador, en nuestro caso un cubo con todas sus caras y vertices.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#"><span style="color:#75715e">//                                  ┌∩┐(◣_◢)┌∩┐
</span><span style="color:#75715e">//																				\\
</span><span style="color:#75715e">// Player.cs (16/07/2018)														\\
</span><span style="color:#75715e">// Autor: Antonio Mateo (.\Moon Antonio) 	antoniomt.moon@gmail.com			\\
</span><span style="color:#75715e">// Descripcion:		Controller del jugador/Cliente.								\\
</span><span style="color:#75715e">// Fecha Mod:		16/07/2018													\\
</span><span style="color:#75715e">// Ultima Mod:		Version Inicial												\\
</span><span style="color:#75715e">//******************************************************************************\\
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#region Librerias
</span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> UnityEngine;
<span style="color:#75715e">#endregion
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">namespace</span> MoonAntonio
{
	<span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>	<span style="color:#75715e">/// &lt;para&gt;Controller del jugador/Cliente.&lt;/para&gt;
</span><span style="color:#75715e"></span>	<span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Player</span> : MonoBehaviour 
	{
		<span style="color:#75715e">#region Variables Publicas
</span><span style="color:#75715e"></span>		<span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>		<span style="color:#75715e">/// &lt;para&gt;Prefab del cubo para instanciar.&lt;/para&gt;
</span><span style="color:#75715e"></span>		<span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">public</span> GameObject prefabCubo;                                                   <span style="color:#75715e">// Prefab del cubo para instanciar
</span><span style="color:#75715e"></span>		<span style="color:#75715e">#endregion
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">#region Inicializadores
</span><span style="color:#75715e"></span>		<span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>		<span style="color:#75715e">/// &lt;para&gt;Inicializador de &lt;see cref=&#34;Player&#34;/&gt;.&lt;/para&gt;
</span><span style="color:#75715e"></span>		<span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> Start()<span style="color:#75715e">// Inicializador de Player
</span><span style="color:#75715e"></span>		{
			Instantiate(prefabCubo);
		}
		<span style="color:#75715e">#endregion
</span><span style="color:#75715e"></span>	}
}
</code></pre></div><p>Solo teneis que crear un gameobject, como el modelado o cualquier cubo como el nuestro y vereis su funcionamiento. Como vemos, <strong>esto es lo que realizariamos si queremos crear un objeto en un single player</strong>, sin necesidad de ser multijugador, ahora vamos a realizar los cambios para poder crear la red.</p>
<p>Primero agregaremos <strong>using UnityEngine.Networking;</strong> y heredaremos nuestro script de <strong>NetworkBehaviour</strong> en vez de <strong>MonoBehaviour</strong>. Con esto lo que conseguimos es obtener acceso a la funcionalidad Net de Unity.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> Start()<span style="color:#75715e">// Inicializador de Player
</span><span style="color:#75715e"></span>{
	<span style="color:#75715e">// Comprobamos si es el objeto local
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (!isLocalPlayer)
	{
		<span style="color:#75715e">// Este objeto es de otro jugador
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span>;
	}

	<span style="color:#75715e">// Solo instanciara el cubo si es Local. Es decir, si soy el cliente.
</span><span style="color:#75715e"></span>	Instantiate(prefabCubo);
}
</code></pre></div><p>De esta manera, si el objeto no es nuestro, no instanciaremos nada, ya que no es nuestra autoridad. Solo podemos darle autoridad sobre los clientes al servidor. Los demas clientes no tienen que tener autoridad sobre ningun cliente que no sea el suyo propio.</p>
<hr>
<!-- raw HTML omitted -->
<hr>
<p>Bien, ahora con todo esto, tenemos que aprender unos nuevos conceptos. ¿Por que la instanciacion debe de realizarse desde el cliente? En realidad no, deberia realizarse desde el servidor. Vamos a ver esto en mas profundidad.</p>
<p>En el metodo Start(), donde teniamos la instanciacion de nuestra unidad, deberiamos borrarla y colocar lo siguiente.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#"><span style="color:#75715e">// Decir al servidor que instancie nuestra unidad
</span><span style="color:#75715e"></span>CmdSpawnUnidad();
</code></pre></div><p>Simplemente indicamos que se llame a un metodo, lo interesante viene en ese metodo. <strong>Una nota antes de seguir, es ver que el prefijo del metodo es <code>Cmd</code></strong>, esto es una decisión que se tomo por parte de Unity3D, no se bien por que, pero es un protocolo a seguir si no quieres que te de un error. Todos los metodos que sean llamados desde el servidor deberan llevar el prefijo <strong>Cmd</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// &lt;para&gt;Le dice al servidor que instancie la unidad.&lt;/para&gt;
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">[Command]</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> CmdSpawnUnidad()
{
	GInstantiate(prefabCubo);
}
</code></pre></div><p>Ahora en nuestro metodo, vemos como colocamos el atributo [Command], esto indica, que este metodo sera ejecutado por el servidor, en vez de por nuestro cliente. Por lo que creara el objeto y lo propagara hasta los clientes.</p>
<p>Al ejecutar os dara un error, esto es por que nuestro objeto Unidad, no tiene un identificador de red, es decir el componente NetworkIdentity. Todos los objetos que van a ser modificados por la red, tienen que tener un identificador.</p>
<p>Tambien todos los objetos tienen que ser agregados en <strong>Registered Spawnable Prefabs</strong>.</p>
<hr>
<!-- raw HTML omitted -->
<hr>
<p>Despues tenemos un atributo muy peculiar que puede ser agregado a las variables que necesiten que se sincronizen desde el servidor hasta los clientes. Este atributo es <strong>[SyncVar]</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// &lt;para&gt;Nombre del player.&lt;/para&gt;
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">[SyncVar]</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> nombre = <span style="color:#e6db74">&#34;name&#34;</span>;
</code></pre></div><p>Ahora tenemos que usar el atributo <strong>RPC</strong>, que lo que realiza es que cuando llama el servidor a este metodo, es ejecutado en todos los clientes. Cuando usamos este atributo, también hay que modificar el prefijo con Rpc.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// &lt;para&gt;Cambia el nombre del jugador.&lt;/para&gt;
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e">/// &lt;param name=&#34;newNombre&#34;&gt;&lt;/param&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">[ClientRpc]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> RpcCambiarNombre(<span style="color:#66d9ef">string</span> newNombre)<span style="color:#75715e">// Cambia el nombre del jugador
</span><span style="color:#75715e"></span>{
	nombre = newNombre;
}
</code></pre></div><p>De momento eso es lo principal para poder crear las conexiones entre clientes y servidores. Animo a todo el mundo a descubrir esta especie de magia que seguro que os encantara como al 100% de la gente que aprende y terminareis construyendo e investigando mas y mas. Un saludo.</p>
<p>PD: Hay mucha mas info y cosillas que explicar, pero eso sera otra historia.</p>
<hr>
<!-- raw HTML omitted -->
<p>.\Moon</p>


			
		</section>
	</article>

	
	<div class="comments contribute-link">

	</div>
	<div class="comments related-posts">
		
			

<h3>Continuar Leyendo</h3>
<ul>
	
	<li><a href="/post/2018/dev/007/">WebClient gestor de conexiones Unity3D</a></li>
	
	<li><a href="/post/2018/comun/007/">El Arte del diseño</a></li>
	
	<li><a href="/post/2018/amv/005/">[Vine] - Bat Girl Xtrem</a></li>
	
	<li><a href="/post/2018/comun/006/">Terra Battle 2!?</a></li>
	
	<li><a href="/post/2018/comun/005/">Steam en 2018</a></li>
	
</ul>

		
	</div>
	
	</div>

	<footer class="site-footer">
	<p class="text">&copy; 2020 - Moon Antonio</p>
</footer>
<script src='/js/prism.js'></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-89564434-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</body>
</html>
