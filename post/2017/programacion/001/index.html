<!DOCTYPE html>
<html lang="es-es">
<head>
	<title>C#: utilizar MEGA API CLIENT &middot; Antonio Moon´s</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Moon Antonio">
	<meta name="description" content="un blog sobre mi, juegos, desarrollo y anime">
	<meta name="keywords" content="Moon,Antonio,Dev,Game">
	<meta name="generator" content="Hugo 0.74.3" />

	<!-- CSS -->
	<link rel="stylesheet" href="https://moonantonio.github.io/css/main.css">
	<link rel='stylesheet' href='/css/prism.css' />
	
	<!-- Favicon -->
	<link rel="apple-touch-icon" href="https://moonantonio.github.io/apple-touch-icon.png">
	<link rel="shortcut icon" href="https://moonantonio.github.io/favicon.ico" type="image/x-icon">
	<link rel="icon" type="image/png" sizes="32x32" href="https://moonantonio.github.io/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://moonantonio.github.io/favicon-16x16.png">
	<link rel="manifest" href="https://moonantonio.github.io/site.webmanifest">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">

	

	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/solid.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/brands.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/fontawesome.min.css">

	<!-- Google Fonts -->
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
</head>

<body>
	<header class="site-header">
	<div class="branding">
		<a href="https://moonantonio.github.io/">
		<img class="avatar" src="https://moonantonio.github.io/img/avatar.png" alt="avatar"/>
		</a>
		<h1 class="site-title">
				<i class="fas fa-angle-right"></i>
				<span class="logo__text">Antonio Moon´s</span>
				<span class="logo__cursor"></span>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/devblog/" title="devBlog">
  		</i>&nbsp; devBlog</a> <i class="fas fa-gamepad" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/backdoor" title="BackDoor">
  		</i>&nbsp; BackDoor</a> <i class="fab fa-black-tie" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://github.com/MoonAntonio/rec.repos" title="Public">
  		</i>&nbsp; Publico</a> <i class="fas fa-code" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/portfolio/" title="About">
  		</i>&nbsp; About</a> <i class="fas fa-terminal" aria-hidden="true"></i>
  </a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/" title="&#43;">
		</i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>
	</a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/" title="">
		<i class="fas fa-fw fa-home"></i>
	</a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/index.xml" title="Subcribe">
		<i class="fas fa-fw fa-rss"></i>
	</a>
</li>

<li class="icon">
	<a href="mailto:antoniomt.moon@gmail.com" title="Email">
		<i class="fas fa-fw fa-envelope"></i>
	</a>
</li>



<li class="icon">
	<a href="https://bitbucket.org/MoonAntonio" rel="me" title="Bitbucket">
		<i class="fab fa-fw fa-bitbucket"></i>
	</a>
</li>







<li class="icon">
	<a href="https://github.com/MoonAntonio" rel="me" title="GitHub">
		<i class="fab fa-fw fa-github"></i>
	</a>
</li>

























<li class="icon">
	<a href="https://trello.com/antoniomoon" rel="me" title="Trello">
		<i class="fab fa-fw fa-trello"></i>
	</a>
</li>

<li class="icon">
	<a href="https://gitlab.com/MoonAntonio" rel="me" title="Gitlab">
		<i class="fab fa-fw fa-gitlab"></i>
	</a>
</li>





		</ul>
	</nav>
</header>


	<div class="content">
	<article class="feature-image">
		<header style="background-image: url('https://moonantonio.github.io/img/bg.png')">
			
			<h1 class="title">C#: utilizar MEGA API CLIENT</h1>
			
		</header>

		<section class="post-content">
			<!-- raw HTML omitted -->
<blockquote>
<p>Mega es el sucesor del servicio de archivos en la nube Megaupload, para aquellos a los que no les suena ninguno de los dos es como un dropbox, un servicio gratuito o de pago dependiendo del espacio que utilizamos para poder subir nuestros archivos. En mi opinión es un servicio increíble que nos permite almacenar copias de seguridad de archivos en la nube y/o compartirlos.</p>
</blockquote>
<blockquote>
<p>En esta entrada mostraré como desde un proyecto en .Net en este caso con C# podéis subir archivos a mega. Además de subir archivos también podréis eliminar, modificar, mover y varias funciones más. Para comenzar tendréis que incorporar a vuestro proyecto varias referencias, si lo realizáis desde el administrador de paquetes nuget de Visual Studio ahorraréis tiempo y faena. Para abrir el administrador de paquetes nuget vamos a la barra principal de arriba y seleccionamos proyecto y administrar paquetes nuget. En la caja de búsqueda ponéis “mega.co.nz” sin comillas, y debe aparecer una librería que hará de cliente contra los servidores de mega, la seleccionáis y le dais a instalar. Además instalará automáticamente otra llamada Newtonsoft.Json que utilizará la librería mega para realizar algunas acciones.</p>
</blockquote>
<blockquote>
<p>Tenemos el proyecto listo para empezar a utilizar los métodos y funciones que nos facilita mega en la clase que queramos, con ello vamos a la clase desde la que queramos que se suba el archivo y añadimos dos directivas using, la primera hace referencia a la api mega y la segunda nos permitirá crear un hilo y de este modo no bloquear nuestra aplicación mientras se realizan algunas tareas en línea:</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#"><span style="color:#66d9ef">using</span> CG.Web.MegaApiClient;
<span style="color:#66d9ef">using</span> System.Threading.Tasks;

</code></pre></div><blockquote>
<p>Ahora vamos con el método que se encargará de realizar la subida del archivo, actualizar la progressbar, y actualizar el texto de un label que irá informando al usuario de como va el proceso. El método es llamado dentro del evento “Shown” del form, y el form lo llamo mediante “ShowDialog()” desde el evento click de un botón de otro form, de esta manera es como una ventana emergente que no desaparecerá hasta que termine el proceso (entre 10 y 40 segundos). Para que quede mas claro, tenemos el “Form1” con un botón, este botón llamará al “Form2” mediante “ShowDialog()”, y dentro del evento “Shown” del “Form2” realizaremos la llamada al método encargado de subir el archivo “subirArchivoAMega()”.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C#" data-lang="C#"><span style="color:#75715e">//Declaración de un hilo
</span><span style="color:#75715e"></span> <span style="color:#66d9ef">private</span> Thread t;
 

 <span style="color:#75715e">//Evento Shown que instancia y ejecuta el hilo (este evento se ejecuta después del Load).
</span><span style="color:#75715e"></span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> Form2_Shown(<span style="color:#66d9ef">object</span> sender, EventArgs e)
 {
     <span style="color:#75715e">//Instancia un hilo para ejecutar el método &#34;subirArchivoAMega&#34;.
</span><span style="color:#75715e"></span>     t = <span style="color:#66d9ef">new</span> Thread(subirArchivoAMega);
     t.Start();
 }
<span style="color:#75715e">// Método que se encarga de subir el archivo a la nuve con la api &#34;Mega&#34;.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> subirArchivoAMega() {
    <span style="color:#66d9ef">try</span> {
          <span style="color:#75715e">// Actualizar el label para informar al usuario.
</span><span style="color:#75715e"></span>          lblInfo.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { lblInfo.Text = <span style="color:#e6db74">&#34;Conectando como &#39;tu_cuenta_de_email@gmail.com&#39;&#34;</span>; }));
          <span style="color:#75715e">// Aumentar la barra de progreso.
</span><span style="color:#75715e"></span>          progressBar1.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { progressBar1.PerformStep(); }));
          <span style="color:#75715e">// Instancia de un cliente para conectar con mega.
</span><span style="color:#75715e"></span>          MegaApiClient cliente = <span style="color:#66d9ef">new</span> MegaApiClient();
          <span style="color:#75715e">// Inicio de sesión con el cliente, pasando el correo y la contraseña de la cuenta mega a la que se sube el archivo.
</span><span style="color:#75715e"></span>          cliente.Login(<span style="color:#e6db74">&#34;tu_cuenta_de_email@gmail.com&#34;</span>, <span style="color:#e6db74">&#34;****************&#34;</span>);

          <span style="color:#75715e">// Aumentar la barra de progreso.
</span><span style="color:#75715e"></span>          progressBar1.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { progressBar1.PerformStep(); }));
          <span style="color:#75715e">// Actualizar el label para informar al usuario.
</span><span style="color:#75715e"></span>          lblInfo.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { lblInfo.Text = <span style="color:#e6db74">&#34;Obteniendo directorios...&#34;</span>; }));
          <span style="color:#75715e">// Obtenemos los nodos (directorios/archivos) de la cuenta dentro de una variable.
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">var</span> nodos = cliente.GetNodes();

          <span style="color:#75715e">// Actualizar el label para informar al usuario.
</span><span style="color:#75715e"></span>          lblInfo.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { lblInfo.Text = <span style="color:#e6db74">&#34;Buscando carpeta &#39;Facturas&#39;...&#34;</span>; }));
          <span style="color:#75715e">// Comprobar si existe algún nodo (directorio) que se llame &#34;Facturas&#34; (en mi caso quiero subir el archivo a dicha carpeta).
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">bool</span> existe = cliente.GetNodes().Any(n =&gt; n.Name == <span style="color:#e6db74">&#34;Facturas&#34;</span>);

          <span style="color:#75715e">// Crear dos nodos.
</span><span style="color:#75715e"></span>          Node root;
          Node carpeta;

         <span style="color:#75715e">// Si el directorio facturas existe, se obtiene. Si no existe, se crea.
</span><span style="color:#75715e"></span>         <span style="color:#66d9ef">if</span> (existe == <span style="color:#66d9ef">true</span>) {
              <span style="color:#75715e">// Actualizar el label para informar al usuario.
</span><span style="color:#75715e"></span>              lblInfo.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { lblInfo.Text = <span style="color:#e6db74">&#34;Obteniendo la carpeta &#39;Facturas&#39;....&#34;</span>; }));
              <span style="color:#75715e">// Aumentar la barra de progreso.
</span><span style="color:#75715e"></span>              progressBar1.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { progressBar1.PerformStep(); }));

             <span style="color:#75715e">// Obtenemos el directorio.
</span><span style="color:#75715e"></span>             carpeta = nodos.Single(n =&gt; n.Name == <span style="color:#e6db74">&#34;Facturas&#34;</span>);
         }<span style="color:#66d9ef">else</span> {
             <span style="color:#75715e">// Actualizar label para informar al usuario.
</span><span style="color:#75715e"></span>             lblInfo.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { lblInfo.Text = <span style="color:#e6db74">&#34;Creando carpeta &#39;Facturas&#39;...&#34;</span>; }));
             <span style="color:#75715e">// Aumentar la barra de progreso.
</span><span style="color:#75715e"></span>             progressBar1.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { progressBar1.PerformStep(); }));

             <span style="color:#75715e">//Obtenemos el nodo raíz.
</span><span style="color:#75715e"></span>             root = nodos.Single(n =&gt; n.Type == NodeType.Root);
             <span style="color:#75715e">// Creamos el directorio llamado &#34;Facturas&#34; en la raíz.
</span><span style="color:#75715e"></span>             carpeta = cliente.CreateFolder(<span style="color:#e6db74">&#34;Facturas&#34;</span>, root);
         }

         <span style="color:#75715e">// Aumentar la barra de progreso.
</span><span style="color:#75715e"></span>         progressBar1.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { progressBar1.PerformStep(); }));
         <span style="color:#75715e">// Actualizar label para informar al usuario.
</span><span style="color:#75715e"></span>         lblInfo.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { lblInfo.Text = <span style="color:#e6db74">&#34;Subiendo archivo...&#34;</span>; }));
         <span style="color:#75715e">// Aumentar la barra de progreso.
</span><span style="color:#75715e"></span>         progressBar1.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { progressBar1.PerformStep(); }));

         <span style="color:#75715e">// Subimos el archivo al directorio &#34;Facturas&#34;, pasando la ruta del archivo a subir y el directorio de mega donde debe subirlo.
</span><span style="color:#75715e"></span>         Node archivo = cliente.Upload(<span style="color:#e6db74">@&#34;C\:Mis facturas\factura1.pdf&#34;</span>, carpeta);

         <span style="color:#75715e">// Obtener el link de descarga del archivo subido por si se requiere para algo.
</span><span style="color:#75715e"></span>         Uri downloadUrl = cliente.GetDownloadLink(archivo);
         <span style="color:#75715e">// Actualizar label para informar al usuario.
</span><span style="color:#75715e"></span>         lblInfo.Invoke(<span style="color:#66d9ef">new</span> MethodInvoker(<span style="color:#66d9ef">delegate</span> { lblInfo.Text = <span style="color:#e6db74">&#34;Archivo subido con éxito.&#34;</span>; }));

    }<span style="color:#66d9ef">catch</span> (Exception error){
        <span style="color:#75715e">// Algo ha fallado, abortamos el subproceso.
</span><span style="color:#75715e"></span>        t.Abort();
        <span style="color:#75715e">// Mensaje en pantalla para informar al usuario del error.
</span><span style="color:#75715e"></span>        MessageBox.Show(<span style="color:#e6db74">&#34;Error al intentar subir el archivo. &#34;</span> + error.Message, <span style="color:#e6db74">&#34;Error&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Error);
    }

    <span style="color:#75715e">// No se puede cerrar el form desde un subproceso ya que no es desde donde se ha creado. Con este código podemos cerrarlo.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.Invoke((MethodInvoker)<span style="color:#66d9ef">delegate</span>{
        <span style="color:#66d9ef">this</span>.Close();
    });
}

</code></pre></div><blockquote>
<p>Si os fijáis, hago constantemente referencias a elementos del form, el motivo es para que el usuario sepa en todo momento la evolución del proceso. Para acceder a los componentes de un form no podemos hacerlo directamente desde un subproceso, por eso utilizamos el método “Invoke” que ejecuta el delegado asignado al subproceso y nos permite comunicarnos con el usuario.</p>
</blockquote>
<blockquote>
<p>Finalmente muestro mi diseño del form para que veáis el total de elementos a los que hago referencia en el método, aunque podéis implementar el diseño que os guste.</p>
</blockquote>
<!-- raw HTML omitted -->


			
		</section>
	</article>

	
	<div class="comments contribute-link">

	</div>
	<div class="comments related-posts">
		
			

<h3>Continuar Leyendo</h3>
<ul>
	
	<li><a href="/post/2017/noticias/001/">The Witch and the Hundred Knight 2</a></li>
	
	<li><a href="/post/2017/clase/001/">Explicación IA básica</a></li>
	
	<li><a href="/post/2017/utiles/001/">Comandos Git Fundamentales</a></li>
	
	<li><a href="/post/2017/diario/nuevo-blog/">Nuevo Blog</a></li>
	
	<li><a href="/post/2016/comun/001/">Información sobre P.Ruby</a></li>
	
</ul>

		
	</div>
	
	</div>

	<footer class="site-footer">
	<p class="text">&copy; 2020 - Moon Antonio</p>
</footer>
<script src='/js/prism.js'></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-89564434-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</body>
</html>
